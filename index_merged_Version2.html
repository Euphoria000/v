<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Albany Airbnb D3 可视化（含地理投影）</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 40px; }
    .chart-area { display: flex; gap: 40px; }
    .sidebar { min-width: 200px; }
    .main { flex: 1; }
    .axis path, .axis line { fill: none; stroke: #aaa; shape-rendering: crispEdges; }
    .bar { fill: steelblue; }
    .bar:hover { fill: orange; }
    .bubble { opacity: 0.7; cursor:pointer; }
    .bubble.selected { stroke: red; stroke-width: 2; }
    .borough { fill: #eee; stroke: #999; stroke-width: 1; }
    .borough:hover { fill: #ffe; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 3px 8px; }
    th { background: #f6f6f6; }
    #tooltip {
      position: absolute;
      background: rgba(255,255,255,.97);
      padding: 8px 16px;
      border: 1px solid #aaa;
      pointer-events: none;
      box-shadow: 2px 2px 8px #eee;
      font-size: 13px;
      border-radius: 3px;
      display:none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>Albany Airbnb D3 可视化（含地理投影与交互）</h1>
  <div class="chart-area">
    <div class="sidebar">
      <label>价格区间<br>
        <input type="range" min="0" max="500" value="0" id="priceMin" style="width:90px;">
        ~
        <input type="range" min="0" max="500" value="500" id="priceMax" style="width:90px;">
        <span id="priceRangeLabel"></span>
      </label>
      <br><br>
      <label>房型筛选<br>
        <select multiple size="4" id="roomTypeSelect"></select>
      </label>
    </div>
    <div class="main">
      <svg id="barChart" width="480" height="240"></svg>
      <svg id="geoMap" width="480" height="320"></svg>
    </div>
  </div>
  <div>
    <h3>房源列表（筛选结果）</h3>
    <table id="listingTable">
      <thead>
        <tr>
          <th>名称</th>
          <th>价格</th>
          <th>类型</th>
          <th>主机</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="tooltip"></div>
  <script>
    // 全局变量
    let geojson = null;
    let data = null;
    let projection = null;
    let geoPath = null;

    // 数据和地图同时加载
    Promise.all([
      d3.json("boroughs.geojson"),
      d3.csv("listings.csv")
    ]).then(function([geo, dat]){
      geojson = geo;
      // 修正 price 字段的解析，去掉$和逗号，转为数字
      data = dat.map(d => {
        d.price = parseFloat((d.price || "").replace(/[\$,]/g, "")) || 0;
        d.latitude = +d.latitude;
        d.longitude = +d.longitude;
        d.room_type = d.room_type || d['room_type'] || "未知";
        return d;
      });

      // 价格区间
      const priceExtent = d3.extent(data, d => d.price);
      d3.select("#priceMin").attr("min", priceExtent[0]).attr("max", priceExtent[1]).property("value", priceExtent[0]);
      d3.select("#priceMax").attr("min", priceExtent[0]).attr("max", priceExtent[1]).property("value", priceExtent[1]);

      // 房型选项
      const roomTypes = Array.from(new Set(data.map(d => d.room_type))).filter(Boolean);
      d3.select("#roomTypeSelect").selectAll("option")
        .data(roomTypes)
        .join("option")
        .attr("value", d => d)
        .text(d => d);

      // 地理投影初始化
      const width = 480, height = 320;

      // 用 fitSize 保证 geojson 区域和 SVG 匹配
      projection = d3.geoMercator();
      geoPath = d3.geoPath().projection(projection);
      projection.fitSize([width, height], geojson);

      // 初始选中全部
      d3.select("#roomTypeSelect").selectAll("option").property("selected", true);
      update();
      d3.selectAll("#priceMin, #priceMax, #roomTypeSelect").on("input", update);
    });

    // 主刷新函数
    function update() {
      if(!geojson || !data) return;

      // 获取筛选条件
      const minPrice = +d3.select("#priceMin").property("value");
      const maxPrice = +d3.select("#priceMax").property("value");
      const selectedTypes = Array.from(d3.select("#roomTypeSelect").property("selectedOptions")).map(d => d.value);

      d3.select("#priceRangeLabel").text(`${minPrice}~${maxPrice}`);

      // 过滤数据
      const filtered = data.filter(d =>
        d.price >= minPrice &&
        d.price <= maxPrice &&
        (selectedTypes.length === 0 || selectedTypes.includes(d.room_type)) &&
        d.latitude && d.longitude
      );

      // 柱状图（价格分布）
      const svgBar = d3.select("#barChart");
      svgBar.selectAll("*").remove();
      const margin = {top:30, right:20, bottom:30, left:50};
      const width = +svgBar.attr("width") - margin.left - margin.right;
      const height = +svgBar.attr("height") - margin.top - margin.bottom;
      const g = svgBar.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const x = d3.scaleLinear().domain([minPrice, maxPrice]).range([0, width]);
      const bins = d3.bin().thresholds(20).value(d => d.price)(filtered);
      const y = d3.scaleLinear().domain([0, d3.max(bins, d => d.length) || 1]).range([height, 0]);
      g.append("g").call(d3.axisLeft(y));
      g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
      g.selectAll(".bar")
        .data(bins)
        .join("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.x0))
        .attr("width", d => Math.max(1, x(d.x1) - x(d.x0) - 1))
        .attr("y", d => y(d.length))
        .attr("height", d => height - y(d.length));

      // 地理气泡地图
      const svgMap = d3.select("#geoMap");
      svgMap.selectAll("*").remove();

      // 1. GeoJSON底图
      svgMap.append("g")
        .attr("class","boroughs")
        .selectAll("path")
        .data(geojson.features)
        .join("path")
        .attr("class", "borough")
        .attr("d", geoPath)
        .append("title")
        .text(d => d.properties.BoroName);

      // 2. 气泡层
      const bubbleG = svgMap.append("g").attr("class","bubbles");
      bubbleG.selectAll("circle")
        .data(filtered)
        .join("circle")
        .attr("class", "bubble")
        .attr("cx", d => {
          const p = projection([d.longitude, d.latitude]);
          return p ? p[0] : -9999;
        })
        .attr("cy", d => {
          const p = projection([d.longitude, d.latitude]);
          return p ? p[1] : -9999;
        })
        .attr("r", d => Math.max(3, Math.sqrt(d.price)/2 + 3)) // 设定最小半径3，避免过小
        .attr("fill", "skyblue")
        .attr("stroke", "#333")
        .on("mouseover", function(e, d){
          d3.select(this).attr("stroke", "red").attr("stroke-width", 2);
          showTooltip(e, d);
        })
        .on("mousemove", showTooltip)
        .on("mouseout", function(){
          d3.select(this).attr("stroke", "#333").attr("stroke-width", 1);
          hideTooltip();
        });

      // 3. 区域名标签
      svgMap.append("g").selectAll("text")
        .data(geojson.features)
        .join("text")
        .attr("x", d => geoPath.centroid(d)[0])
        .attr("y", d => geoPath.centroid(d)[1])
        .attr("text-anchor", "middle")
        .attr("dy", ".35em")
        .attr("fill", "#666")
        .attr("font-size", "12px")
        .attr("pointer-events","none")
        .text(d => d.properties.BoroName);

      // 4. 表格
      const tbody = d3.select("#listingTable tbody");
      tbody.selectAll("tr").remove();
      tbody.selectAll("tr")
        .data(filtered)   
        .join("tr")
        .html(d => `
          <td>${d.name || ""}</td>
          <td>$${d.price}</td>
          <td>${d.room_type}</td>
          <td>${d.host_name || ""}</td>
        `);
    }

    // 工具提示
    function showTooltip(event, d) {
      const tt = d3.select("#tooltip");
      tt.style("display", "block")
        .style("left", (event.pageX+15)+"px")
        .style("top", (event.pageY-10)+"px")
        .html(`<b>${d.name}</b><br>价格: $${d.price}<br>类型: ${d.room_type}`);
    }
    function hideTooltip() {
      d3.select("#tooltip").style("display", "none");
    }
  </script>
</body>
</html>
